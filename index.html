<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panorama with Ghost & Phone</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<style>
  html,body{height:100%;margin:0;background:#000}
  #panorama{position:fixed;inset:0}

  .ghost{
    position:fixed;top:50%;left:50%;
    width:clamp(200px, 30vmin, 600px);
    transform:translate(-50%,-50%);
    pointer-events:none;z-index:30;opacity:.85;
    filter:drop-shadow(0 10px 22px rgba(0,0,0,.55));
    animation: floatAround 40s linear infinite alternate;
    animation-play-state: paused;
  }
  @keyframes floatAround {
    0%   { transform: translate(-50%, -50%) translate(10vw, 10vh) scale(1) rotate(0deg); opacity:0.95; }
    25%  { transform: translate(-50%, -50%) translate(70vw, 15vh) scale(1.05) rotate(3deg); opacity:0.8; }
    50%  { transform: translate(-50%, -50%) translate(60vw, 70vh) scale(1.1) rotate(-4deg); opacity:0.9; }
    75%  { transform: translate(-50%, -50%) translate(20vw, 80vh) scale(1.08) rotate(2deg); opacity:0.85; }
    100% { transform: translate(-50%, -50%) translate(10vw, 10vh) scale(1) rotate(0deg); opacity:0.95; }
  }

  .holding-phone{
    position:fixed;left:50%;bottom:0;transform:translateX(-50%);
    height:70vh;width:auto;pointer-events:none;z-index:25;
    filter:drop-shadow(0 8px 18px rgba(0,0,0,.4));
  }

  .loading{
    position:fixed;inset:0;display:grid;place-items:center;
    color:#e2e8f0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    z-index:5;pointer-events:none;text-shadow:0 2px 6px rgba(0,0,0,.6);
  }

  .intro{
    position:fixed;inset:0;background:rgba(0,0,0,.6);
    display:grid;place-items:center;z-index:100;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
  }
  .intro-card{
    background:rgba(15,23,42,.9);color:#e2e8f0;border:1px solid rgba(255,255,255,.15);
    border-radius:16px;max-width:min(720px,92vw);padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.5);
  }
  .intro-card h2{margin:0 0 .7rem;font-size:1.15rem;line-height:1.4}
  .intro-card p{margin:.2rem 0 1rem;opacity:.9}
  .btn{
    display:inline-block;padding:.85rem 1.2rem;border:0;border-radius:12px;
    background:#22c55e;color:#0b1220;font-weight:700;cursor:pointer;
  }

  .end-wrap{
    position:fixed;inset:0;display:none;place-items:center;z-index:110;
    background:rgba(0,0,0,.45);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
  }
  .end-btn{
    padding:1rem 1.3rem;border:0;border-radius:12px;background:#38bdf8;color:#0b1220;font-weight:800;cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,.45);
  }
</style>
</head>
<body>

<div id="panorama"></div>
<div class="loading" id="loading">載入全景中…</div>

<div class="intro" id="intro">
  <div class="intro-card">
    <h2>拖曳螢幕，將手機對著女人，聽完對話。<br>Drag the screen, aim the phone at the woman, and listen to the conversation.</h2>
    <p>按下按鈕後開始偵測與播放。/ Start detection and audio after you press the button.</p>
    <button class="btn" id="startBtn">知道了！ / Got it!</button>
  </div>
</div>

<div class="end-wrap" id="endWrap">
  <!-- fallback link + button -->
  <a id="fallbackLink" class="end-btn" href="https://ths.li/nNKw9mg" target="_top" rel="noopener">
    去榕樹洞 / Go to the banyan tree hollow
  </a>
</div>

<img src="holdingphone.png" alt="" class="holding-phone" id="holdingPhone" />
<img src="ghost.png" alt="" class="ghost" id="ghost" />

<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<script>
  const viewer = pannellum.viewer('panorama', {
    type: 'equirectangular',
    panorama: 'panorama.jpg',
    autoLoad: true,
    showControls: true,
    hfov: 100,
    backgroundColor: [0,0,0]
  });

  viewer.on('load', () => {
    const loading = document.getElementById('loading');
    if (loading) loading.style.display = 'none';
  });

  const intro = document.getElementById('intro');
  const startBtn = document.getElementById('startBtn');
  const ghost = document.getElementById('ghost');
  const holding = document.getElementById('holdingPhone');
  const endWrap = document.getElementById('endWrap');
  const fallbackLink = document.getElementById('fallbackLink');

  const audio = new Audio('ghostaudio.mp3');
  audio.preload = 'auto';
  audio.loop = false;

  let monitoring = false;

  startBtn.addEventListener('click', () => {
    intro.style.display = 'none';
    ghost.style.animationPlayState = 'running';
    monitoring = true;
    requestAnimationFrame(tick);
  });

  audio.addEventListener('ended', () => {
    endWrap.style.display = 'grid';
  });

  // 完成後導向網址（含 sandbox fallback）
  (function(){
    const targetURL = "https://ths.li/nNKw9mg";
    function replaceTop(url){
      try {
        window.top.location.replace(url);
      } catch(err){
        console.warn("Top navigation blocked:", err);
        alert("此頁面被 sandbox 限制，無法取代整頁，請上層網站加入 allow-top-navigation-by-user-activation。");
        document.getElementById('fallbackLink').click();
      }
    }
    fallbackLink.addEventListener('click', function(e){
      e.preventDefault();
      replaceTop(targetURL);
    });
  })();

  function tick(){
    if (!monitoring) return;
    const gRect = ghost.getBoundingClientRect();
    const pRect = holding.getBoundingClientRect();
    const phoneTop = pRect.top;
    const horizontalOverlap = !(pRect.right < gRect.left || pRect.left > gRect.right);
    const topHitsGhost = phoneTop <= gRect.bottom && phoneTop >= gRect.top;
    const isColliding = horizontalOverlap && topHitsGhost;

    if (isColliding) {
      if (audio.paused && !audio.ended) {
        audio.play().catch(()=>{});
      }
    } else {
      if (!audio.paused && !audio.ended) {
        audio.pause();
      }
    }
    requestAnimationFrame(tick);
  }
</script>

<noscript>需要啟用 JavaScript 才能檢視 360° 全景。</noscript>
</body>
</html>