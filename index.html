<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>飄動幽靈全景</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden;}
  #panorama{position:fixed;inset:0;}

  /* 幽靈改為固定在螢幕上飄動，不受視角影響 */
  #ghost{
    position:fixed;
    top:50%; left:50%;
    width:clamp(250px,30vmin,600px);
    transform:translate(-50%,-50%);
    pointer-events:none;
    opacity:.9;
    z-index:30;
    animation: wander 60s linear infinite;
  }
  @keyframes wander{
    0%   {transform:translate(0vw,0vh) scale(1);}
    25%  {transform:translate(30vw, -10vh) scale(1.1);}
    50%  {transform:translate(-25vw, 15vh) scale(0.9);}
    75%  {transform:translate(20vw, 25vh) scale(1.05);}
    100% {transform:translate(0vw,0vh) scale(1);}
  }

  .holding-phone{
    position:fixed;left:50%;bottom:0;transform:translateX(-50%);
    height:70vh;width:auto;pointer-events:none;z-index:25;
  }

  .intro,.end-wrap{
    position:fixed;inset:0;display:grid;place-items:center;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
  }
  .intro{background:rgba(0,0,0,.6);z-index:100;}
  .intro-card{
    background:rgba(15,23,42,.9);color:#e2e8f0;border:1px solid rgba(255,255,255,.15);
    border-radius:16px;max-width:min(720px,92vw);padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.5);
  }
  .intro-card h2{margin:0 0 .7rem;font-size:1.15rem;line-height:1.4}
  .intro-card p{margin:.2rem 0 1rem;opacity:.9}
  .btn{
    display:inline-block;padding:.85rem 1.2rem;border:0;border-radius:12px;
    background:#22c55e;color:#0b1220;font-weight:700;cursor:pointer;
  }

  .end-wrap{background:rgba(0,0,0,.45);display:none;z-index:110;}
  .end-btn{
    padding:1rem 1.3rem;border:0;border-radius:12px;background:#38bdf8;color:#0b1220;font-weight:800;cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,.45);
    text-decoration:none;
  }
</style>
</head>
<body>

<div id="panorama"></div>
<div class="intro" id="intro">
  <div class="intro-card">
    <h2>拖曳螢幕，將手機對著女人，聽完對話。<br>Drag the screen, aim the phone at the woman, and listen to the conversation.</h2>
    <p>按下按鈕後開始偵測與播放。/ Start detection and audio after you press the button.</p>
    <button class="btn" id="startBtn" type="button">知道了！ / Got it!</button>
  </div>
</div>

<div class="end-wrap" id="endWrap">
  <a id="fallbackLink" class="end-btn" href="https://ths.li/nNKw9mg" target="_top" rel="noopener">
    去榕樹洞 / Go to the banyan tree hollow
  </a>
</div>

<img src="ghost.png" id="ghost" alt="">
<img src="holdingphone.png" class="holding-phone" id="holdingPhone" alt="">

<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<script>
const viewer = pannellum.viewer('panorama',{
  type:'equirectangular',
  panorama:'panorama.jpg',
  autoLoad:true,
  showControls:true,
  hfov:100,
  backgroundColor:[0,0,0]
});

const intro=document.getElementById('intro');
const startBtn=document.getElementById('startBtn');
const ghost=document.getElementById('ghost');
const holding=document.getElementById('holdingPhone');
const endWrap=document.getElementById('endWrap');
const fallbackLink=document.getElementById('fallbackLink');

const audio=new Audio('ghostaudio.mp3');
audio.preload='auto';
audio.loop=false;

let monitoring=false;

startBtn.onclick=()=>{
  intro.style.display='none';
  monitoring=true;
  requestAnimationFrame(tick);
};

audio.onended=()=>{ endWrap.style.display='grid'; };

(function(){
  const targetURL="https://ths.li/nNKw9mg";
  function replaceTop(url){
    try{ window.top.location.replace(url); }
    catch(err){
      console.warn("Top navigation blocked:",err);
      document.getElementById('fallbackLink').click();
    }
  }
  fallbackLink.addEventListener('click',e=>{
    e.preventDefault(); replaceTop(targetURL);
  });
})();

function tick(){
  if(!monitoring)return;
  const gRect=ghost.getBoundingClientRect();
  const pRect=holding.getBoundingClientRect();
  const phoneTop=pRect.top;
  const overlap=!(pRect.right<gRect.left||pRect.left>gRect.right);
  const hit=overlap && phoneTop<=gRect.bottom && phoneTop>=gRect.top;

  if(hit){
    if(audio.paused&&!audio.ended){audio.play().catch(()=>{});}
  }else{
    if(!audio.paused&&!audio.ended){audio.pause();}
  }
  requestAnimationFrame(tick);
}
</script>
</body>
</html>
